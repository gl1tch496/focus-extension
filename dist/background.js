(()=>{"use strict";const t={get:async t=>new Promise(e=>{chrome.storage.sync.get(t,e)}),set:async t=>new Promise(e=>{chrome.storage.sync.set(t,e)}),async getSettings(){const t={enabled:!1,blockedSites:["facebook.com","twitter.com","youtube.com","reddit.com","instagram.com"],whitelist:[],whitelistedChannels:[],whitelistedSubreddits:[],schedule:{enabled:!1,startHour:9,endHour:17,weekdaysOnly:!0},pomodoro:{workDuration:25,breakDuration:5,active:!1,currentSession:"work",endTime:null,startTime:null,completedSessions:0},nuclearPhrase:"I need to focus on my work",stats:{sitesBlocked:0,timeSaved:0,lastReset:Date.now(),blockedToday:0,lastBlockDate:null},analyticsHistory:this.generateInitialHistory()},e=await this.get(Object.keys(t));return{...t,...e}},generateInitialHistory:()=>["Mon","Tue","Wed","Thu","Fri","Sat","Sun"].map((t,e)=>({day:t,blocked:Math.floor(20*Math.random())+5,productive:Math.floor(100*Math.random())+60})),async updateStats(t=1){const e=await this.getSettings(),o=(new Date).toDateString();return e.stats.lastBlockDate!==o&&(e.stats.blockedToday=0,e.stats.lastBlockDate=o),e.stats.sitesBlocked+=t,e.stats.blockedToday+=t,e.stats.timeSaved+=5,await this.set({stats:e.stats}),await this.updateAnalyticsHistory(t),e.stats},async updateAnalyticsHistory(t=1){const e=(await this.getSettings()).analyticsHistory||this.generateInitialHistory(),o=["Sun","Mon","Tue","Wed","Thu","Fri","Sat"][(new Date).getDay()],s=e.find(t=>t.day===o);s&&(s.blocked+=t,s.productive+=Math.floor(10*Math.random())+5),await this.set({analyticsHistory:e})},async getDetailedStats(){const t=(await this.getSettings()).stats,e=Math.floor((Date.now()-t.lastReset)/864e5)||1,o=(t.sitesBlocked/e).toFixed(1),s=(t.timeSaved/e).toFixed(0),a=Math.min(100,Math.floor(2*t.sitesBlocked));return{...t,daysActive:e,avgBlocksPerDay:o,avgTimePerDay:s,productivityScore:a,totalHours:(t.timeSaved/60).toFixed(1)}},async exportData(){return{settings:await this.getSettings(),stats:await this.getDetailedStats(),exportDate:(new Date).toISOString(),version:"2.0"}},async importData(t){try{return t.settings&&await this.set(t.settings),!0}catch(t){return console.error("Import failed:",t),!1}},async clearAllData(){await chrome.storage.sync.clear(),await chrome.storage.local.clear()},getSiteStats:async()=>(await chrome.storage.local.get("siteStats")||{}).siteStats||{},async updateSiteStats(t){const e=await this.getSiteStats();e[t]=(e[t]||0)+1,await chrome.storage.local.set({siteStats:e})},async getTopBlockedSites(t=5){const e=await this.getSiteStats();return Object.entries(e).sort((t,e)=>e[1]-t[1]).slice(0,t).map(([t,e])=>({site:t,count:e}))}},e={isBlocked(t,e){if(!e.enabled)return!1;if(e.schedule.enabled&&!this.isInSchedule(e.schedule))return!1;const o=new URL(t).hostname.replace("www.","");if(e.whitelist.some(t=>o.includes(t)))return!1;if(o.includes("youtube.com")&&t.includes("/channel/")){const o=t.match(/\/channel\/([^/?]+)/);if(o&&e.whitelistedChannels.includes(o[1]))return!1}if(o.includes("youtube.com")&&t.includes("/@")){const o=t.match(/\/@([^/?]+)/);if(o&&e.whitelistedChannels.includes(o[1]))return!1}if(o.includes("reddit.com")&&t.includes("/r/")){const o=t.match(/\/r\/([^/?]+)/);if(o&&e.whitelistedSubreddits.includes(o[1]))return!1}return e.blockedSites.some(t=>o.includes(t))},isInSchedule(t){const e=new Date,o=e.getHours(),s=e.getDay();return(!t.weekdaysOnly||0!==s&&6!==s)&&o>=t.startHour&&o<t.endHour},getBlockReason(t,e){const o=new URL(t).hostname.replace("www.","");if(!e.enabled)return"Blocker is disabled";if(e.schedule.enabled&&!this.isInSchedule(e.schedule))return"Outside scheduled blocking hours";const s=e.blockedSites.find(t=>o.includes(t));return s?`${s} is on your block list`:"Site is blocked"}},o={async startPomodoro(t){const e="work"===t.pomodoro.currentSession?t.pomodoro.workDuration:t.pomodoro.breakDuration,o=Date.now()+60*e*1e3;await chrome.storage.sync.set({pomodoro:{...t.pomodoro,active:!0,endTime:o,startTime:Date.now()}}),chrome.alarms.create("pomodoroEnd",{when:o}),this.trackSession("start",t.pomodoro.currentSession)},async stopPomodoro(){chrome.alarms.clear("pomodoroEnd");const t=await chrome.storage.sync.get("pomodoro");await chrome.storage.sync.set({pomodoro:{...t.pomodoro,active:!1,endTime:null,startTime:null}}),this.trackSession("stop",t.pomodoro.currentSession)},async switchSession(t){const e="work"===t.pomodoro.currentSession?"break":"work",o=(t.pomodoro.completedSessions||0)+1;await chrome.storage.sync.set({pomodoro:{...t.pomodoro,currentSession:e,active:!1,completedSessions:o}}),this.trackSession("complete",t.pomodoro.currentSession),chrome.notifications&&chrome.notifications.create({type:"basic",iconUrl:"icon128.png",title:"work"===e?"Break Time!":"Back to Work!",message:"work"===e?"Take a well-deserved break. You've earned it!":"Break's over. Time to focus!",priority:2})},getTimeRemaining:t=>t?Math.max(0,Math.floor((t-Date.now())/1e3)):0,formatTime:t=>`${Math.floor(t/60)}:${(t%60).toString().padStart(2,"0")}`,getProgress(t,e){if(!t||!e)return 0;const o=e-t,s=Date.now()-t;return Math.min(100,Math.floor(s/o*100))},async trackSession(t,e){const o=(new Date).toISOString().split("T")[0],s=(await chrome.storage.local.get("sessionHistory")||{}).sessionHistory||{};s[o]||(s[o]={work:0,break:0}),"complete"===t&&(s[o][e]=(s[o][e]||0)+1),await chrome.storage.local.set({sessionHistory:s})},async getSessionStats(t=7){const e=(await chrome.storage.local.get("sessionHistory")||{}).sessionHistory||{},o=[],s=new Date;for(let a=t-1;a>=0;a--){const t=new Date(s);t.setDate(t.getDate()-a);const i=t.toISOString().split("T")[0],r=e[i]||{work:0,break:0};o.push({date:i,workSessions:r.work||0,breakSessions:r.break||0})}return o}};chrome.tabs.onUpdated.addListener(async(o,s,a)=>{if("loading"===s.status&&a.url){const s=await t.getSettings();if(e.isBlocked(a.url,s)){const e=chrome.runtime.getURL("blocked.html")+"?url="+encodeURIComponent(a.url);chrome.tabs.update(o,{url:e}),await t.updateStats()}}}),chrome.alarms.onAlarm.addListener(async e=>{if("pomodoroEnd"===e.name){const e=await t.getSettings();chrome.notifications.create({type:"basic",iconUrl:"icons/icon128.png",title:"Pomodoro Complete!",message:"work"===e.pomodoro.currentSession?"Time for a break!":"Break over! Ready to focus?"}),await o.switchSession(e)}}),chrome.runtime.onInstalled.addListener(async()=>{const e=await t.getSettings();await t.set(e)}),console.log("Focus Mode background script loaded")})();